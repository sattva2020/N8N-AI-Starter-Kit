# Распространенные проблемы и их решения

В этом документе собраны наиболее часто встречающиеся проблемы при установке и использовании N8N AI Starter Kit, а также способы их решения.

## Содержание

- [Проблемы с переменными окружения](#проблемы-с-переменными-окружения)
- [Конфликты сетей Docker](#конфликты-сетей-docker)
- [Проблемы с хешем пароля Traefik](#проблемы-с-хешем-пароля-traefik)
- [Ошибка "concurrent map writes"](#ошибка-concurrent-map-writes)
- [Проблемы с установкой и настройкой](#проблемы-с-установкой-и-настройкой)
- [Проблемы с Docker и Docker Compose](#проблемы-с-docker-и-docker-compose)
- [Проблемы с системными требованиями](#проблемы-с-системными-требованиями)
- [Проблемы с определением GPU](#проблемы-с-определением-gpu)
- [Проблемы с портами и сетями](#проблемы-с-портами-и-сетями)
- [Скрипты автоматического исправления](#скрипты-автоматического-исправления)

## Проблемы с переменными окружения

### Предупреждения о неопределенных переменных

**Симптомы:**
При запуске системы вы можете увидеть множество предупреждений вида:

```
WARN[0000] The "JWT_SECRET" variable is not set. Defaulting to a blank string.
WARN[0000] The "ANON_KEY" variable is not set. Defaulting to a blank string.
WARN[0000] The "SERVICE_ROLE_KEY" variable is not set. Defaulting to a blank string.
```

**Причина:**
В Docker Compose файлах используются переменные с именами, отличающимися от тех, что определены в файле `.env`. Например, в compose-файлах используются `ANON_KEY` и `SERVICE_ROLE_KEY`, а в `.env` они определены как `SUPABASE_ANON_KEY` и `SUPABASE_SERVICE_ROLE_KEY`.

### Автоматическое решение

#### Для Linux/macOS

```bash
./scripts/fix-env-vars.sh
```

Затем запустите систему с ограниченным параллелизмом:

```bash
./scripts/start-with-limited-parallelism.sh
```

Или используйте комплексный скрипт:

```bash
./scripts/fix-and-start.sh
```

#### Для Windows

```powershell
# Только исправление переменных
.\scripts\fix-env-vars.ps1

# Исправление переменных и запуск системы
.\scripts\fix-and-start.ps1
```

### Ручное решение

Добавьте следующие строки в конец вашего файла `.env`:

```
# ---- SUPABASE ВНУТРЕННИЕ ПЕРЕМЕННЫЕ ----
ANON_KEY=ваш_ключ_из_SUPABASE_ANON_KEY
SERVICE_ROLE_KEY=ваш_ключ_из_SUPABASE_SERVICE_ROLE_KEY
JWT_SECRET=ваш_ключ_из_SUPABASE_JWT_SECRET
```

Замените значения `ваш_ключ_из_*` на соответствующие значения из переменных `SUPABASE_*` в том же файле `.env`.

### Предупреждение о версии Docker Compose

**Симптомы:**
Предупреждения вида:

```
WARN[0000] /root/n8n-ai-starter-kit/compose/optional-services.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion
```

**Решение:**
Атрибут `version` устарел в новых версиях Docker Compose. В последнем обновлении мы удалили его из файлов, чтобы избавиться от этих предупреждений.

## Конфликты сетей Docker

### Ошибка конфликта сетей

**Симптомы:**
При запуске системы возникает ошибка "networks.backend conflicts with imported resource" или "concurrent map writes".

**Причина:**
Конфликт в определении сетей между основным файлом docker-compose.yml и импортированными файлами.

### Автоматическое решение

```bash
./scripts/fix-and-start.sh
```

Этот скрипт:
1. Останавливает все запущенные контейнеры
2. Удаляет неиспользуемые сети Docker
3. Генерирует необходимые переменные окружения
4. Ограничивает параллелизм Docker Compose
5. Запускает систему с профилем CPU
6. Проверяет статус контейнеров

### Ручное решение

1. Остановите все работающие контейнеры:
   ```bash
   docker-compose down
   ```

2. Удалите существующие сети Docker:
   ```bash
   docker network prune -f
   ```

3. Запустите систему с нужными профилями:
   ```bash
   docker-compose --profile cpu up -d
   ```

### Технические детали решения

В майском обновлении 2025 года мы приняли следующие меры:

1. Создали отдельный файл для определения сетей - `compose/networks.yml`
2. В основном файле `docker-compose.yml` полностью удалили определения сетей
3. Добавили импорт файла networks.yml в секцию include
4. Удалили определения сетей в импортируемых файлах
5. Исправили проблему с монтированием Docker сокета
6. Переименовали сервис `db` в `zep-db` для избежания конфликтов имен

## Проблемы с хешем пароля Traefik

### Ошибка с переменными в хеше пароля

**Симптомы:**
При запуске Docker Compose появляются предупреждения вида:

```
WARN[0000] The "apr1" variable is not set. Defaulting to a blank string.
WARN[0000] The "UT95I0NvcgFpXzUL" variable is not set. Defaulting to a blank string.
```

**Причина:**
Docker Compose интерпретирует символы `$` в хеше пароля Traefik как переменные окружения.

### Автоматическое решение

В версии скрипта от мая 2025 эта проблема решена автоматически. При запуске скрипта установки:

```bash
./scripts/setup.sh
```

Скрипт экранирует символы `$` в хеше пароля при создании файла `.env`.

### Ручное решение

1. Откройте файл `.env` в текстовом редакторе
2. Найдите строку, начинающуюся с `TRAEFIK_PASSWORD_HASHED=`
3. Замените каждый символ `$` на `$$` в хеше пароля
4. Сохраните файл и запустите Docker Compose снова

Пример:
```
# Было
TRAEFIK_PASSWORD_HASHED=$apr1$7dtH1v4e$UT95I0NvcgFpXzUL.T47j.

# Должно стать
TRAEFIK_PASSWORD_HASHED=$$apr1$$7dtH1v4e$$UT95I0NvcgFpXzUL.T47j.
```

## Ошибка "concurrent map writes"

**Симптомы:**
При запуске Docker Compose возникает ошибка "fatal error: concurrent map writes".

**Причина:**
Эта ошибка может возникать из-за проблем с параллельным запуском контейнеров и конфликтами в определении сетей.

### Решение

1. Используйте скрипт, ограничивающий параллелизм:
   ```bash
   ./scripts/start-with-limited-parallelism.sh
   ```

2. Или запустите Docker Compose с ограничением параллелизма вручную:
   ```bash
   COMPOSE_PARALLEL_LIMIT=1 docker-compose --profile cpu up -d
   ```

## Проблемы с установкой и настройкой

### Ошибки определения ОС

**Симптомы:**
- Скрипт не может корректно определить ОС
- Используются неверные команды установки

**Решение:**
1. Убедитесь, что ваша ОС поддерживается:
   - Ubuntu (все последние версии)
   - Debian (все последние версии)
   - CentOS/RHEL (7 и выше)
   - Fedora (все последние версии)
   - macOS (с ручной установкой Docker)

2. Запустите скрипт в режиме подробного вывода:
   ```bash
   bash -x scripts/setup.sh
   ```

### Неверное имя домена

**Симптомы:**
Скрипт отклоняет имя домена во время настройки.

**Решение:**
Убедитесь, что имя домена:
- Содержит хотя бы одну точку (.)
- Состоит только из букв, цифр, дефисов
- Не начинается и не заканчивается на дефис
- Является действительным доменным именем верхнего уровня (TLD)

## Проблемы с системными требованиями

### Проблемы с памятью

**Симптомы:**
- Медленная работа системы
- Ошибки при запуске контейнеров из-за нехватки памяти
- Ошибки "вне памяти"

**Требуемая память:**
- Минимум: 4 ГБ ОЗУ
- Рекомендуется: 8 ГБ и более
- Менее 4 ГБ: не рекомендуется

**Решение:**
1. Запустите с ограниченным параллелизмом:
   ```bash
   ./scripts/start-with-limited-parallelism.sh
   ```
2. Отключите необязательные сервисы
3. Увеличьте размер подкачки (swap space)

### Проблемы с ресурсами CPU

**Симптомы:**
- Долгое время запуска контейнеров
- Высокая загрузка CPU
- Невозможность использования системы

**Требуемый CPU:**
- Минимум: 2 ядра
- Рекомендуется: 4 и более
- Менее 2 ядер: ограниченная функциональность

**Решение:**
1. Отключите ресурсоемкие сервисы
2. Запустите в базовом режиме без необязательных сервисов
3. Увеличьте выделение CPU, если работаете в виртуальной машине

### Проблемы с дисковым пространством

**Симптомы:**
- Ошибки при установке
- Ошибки Docker о нехватке места
- Ошибки при запуске сервисов

**Требуемое пространство:**
- Минимум: 10 ГБ свободного места
- Рекомендуется: 20 ГБ и более
- Менее 10 ГБ: не рекомендуется

**Решение:**
1. Очистите ресурсы Docker:
   ```bash
   ./scripts/clean-docker.sh
   ```
2. Удалите неиспользуемые образы и тома
3. Освободите дисковое пространство

## Проблемы с портами и сетями

### Конфликты портов

**Симптомы:**
- Сервисы не запускаются
- Ошибки "порт уже используется"
- Ошибки при запуске Traefik

**Требуемые порты:**
- 80: HTTP
- 443: HTTPS
- Различные другие порты для сервисов

**Решение:**
1. Проверьте использование портов:
   ```bash
   sudo lsof -i :80
   sudo lsof -i :443
   ```
2. Остановите конфликтующие сервисы
3. Измените конфигурацию портов в файлах docker-compose

### Сетевые проблемы

**Симптомы:**
- Ошибки соединения с Docker Hub
- Ошибки SSL/TLS
- Проблемы с сертификатами Let's Encrypt

**Решение:**
1. Проверьте подключение к интернету
2. Проверьте правила брандмауэра
3. Проверьте разрешение DNS
4. Проверьте соединение SSL

## Скрипты автоматического исправления

Для удобства в последнем обновлении мы создали несколько автоматических скриптов:

### Linux/macOS:

- `scripts/fix-env-vars.sh` - исправляет проблемы с переменными окружения
- `scripts/fix-and-start.sh` - автоматически исправляет проблемы и запускает систему
- `scripts/start-with-limited-parallelism.sh` - запускает систему с ограниченным параллелизмом
- `scripts/clean-docker.sh` - очищает ресурсы Docker

### Windows:

- `scripts\fix-env-vars.ps1` - исправляет проблемы с переменными окружения
- `scripts\fix-and-start.ps1` - автоматически исправляет проблемы и запускает систему

Эти скрипты рекомендуется использовать в первую очередь при возникновении проблем, так как они применяют все необходимые исправления автоматически.

## Дополнительная информация

Если вы столкнулись с другими проблемами, не описанными в этом документе, обратитесь к полному руководству по устранению неполадок [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) в корневой директории проекта.

<!-- Обновленные перекрестные ссылки -->
Подробнее о проблемах с переменными окружения смотрите в разделе [Проблемы с переменными окружения](#проблемы-с-переменными-окружения).

Подробнее о конфликтах сетей смотрите в разделе [Конфликты сетей Docker](#конфликты-сетей-docker).

Для получения дополнительной информации обратитесь к полному руководству [TROUBLESHOOTING.md](../TROUBLESHOOTING.md).
