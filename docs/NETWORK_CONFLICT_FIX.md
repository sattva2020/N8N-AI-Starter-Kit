# Исправление сетевых конфликтов в Docker Compose

Если вы сталкиваетесь с ошибкой "networks.backend conflicts with imported resource" или "concurrent map writes" при запуске системы, это происходит из-за конфликта в определении сетей между основным файлом docker-compose.yml и импортированными файлами.

## Автоматическое решение проблемы

Для автоматического применения всех исправлений мы создали специальный скрипт:

```bash
./scripts/fix-and-start.sh
```

Этот скрипт:
1. Останавливает все запущенные контейнеры
2. Удаляет неиспользуемые сети Docker
3. Генерирует необходимые переменные окружения
4. Ограничивает параллелизм Docker Compose для избежания ошибки "concurrent map writes"
5. Запускает систему с профилем CPU
6. Проверяет статус контейнеров

## Ручное решение проблемы

Если вы предпочитаете ручное решение, вот шаги, которые были предприняты:

1. Создали отдельный файл для определения сетей - `compose/networks.yml`:
   ```yaml
   # Общие сети для всех сервисов системы
   
   networks:
     frontend:
     backend:
     database:
   ```

2. В основном файле `docker-compose.yml` полностью удалили определения сетей:
   ```yaml
   # Сети определены в отдельном файле compose/networks.yml
   # и импортируются через директиву include
   ```

3. Добавили импорт файла networks.yml в секцию include в `docker-compose.yml`:
   ```yaml
   include:
     - path: ./compose/networks.yml
     - path: ./compose/zep-compose.yaml
     - path: ./compose/supabase-compose.yml
     - path: ./compose/optional-services.yml
   ```

4. Полностью удалили определения сетей в импортируемых файлах (вместо комментирования):

### В файле `compose/optional-services.yml`:
```yaml
# Сети определены в отдельном файле compose/networks.yml
```

### В файле `compose/zep-compose.yaml`:
```yaml
# Сети определены в общем файле networks.yml
```

### В файле `compose/supabase-compose.yml`:
```yaml
# Сети определены в общем файле networks.yml
```

### В файле `compose/supabase-compose.yml`:
```yaml
# Сети определены в общем файле networks.yml
```

## Почему это решает проблему

В Docker Compose, когда вы используете импорт других файлов compose (через `include` или запуск с несколькими файлами), определения сетей должны быть согласованы между всеми файлами.

Проблема возникала потому что:
- В разных файлах docker-compose могли быть определены одинаковые сети с разными параметрами
- Docker Compose пытался создать одну и ту же сеть дважды
- При параллельном запуске контейнеров возникала ошибка "concurrent map writes" из-за конфликтов в определении сетей

После внесения этих изменений:
1. Все сети определены только в одном месте - файле `compose/networks.yml`
2. Ни в одном из импортируемых файлов нет определений сетей
3. Исправлена ошибка монтирования Docker сокета
4. Переименован сервис `db` в `zep-db` для избежания конфликтов имен

Это решение позволяет полностью устранить ошибки "networks.backend conflicts with imported resource" и "concurrent map writes" при запуске системы с профилем CPU.

## Проверка исправления

Чтобы убедиться, что исправление сработало, выполните следующие шаги:

1. Остановите все работающие контейнеры:
   ```bash
   docker-compose down
   ```

2. Удалите существующие сети Docker (если они есть):
   ```bash
   docker network prune -f
   ```

3. Запустите систему с нужными профилями:
   ```bash
   docker-compose --profile cpu up -d
   ```

4. Проверьте, что все сервисы запустились без ошибок:
   ```bash
   docker-compose ps
   ```

## Исправление проблемы с Docker сокетом

В файле `compose/supabase-compose.yml` была исправлена проблема с монтированием Docker сокета. Переменная окружения `${DOCKER_SOCKET_LOCATION}` была заменена на абсолютный путь:

```yaml
volumes:
  - ./volumes/logs/vector.yml:/etc/vector/vector.yml:ro,z
  - /var/run/docker.sock:/var/run/docker.sock:ro
```

Это позволяет избежать ошибки "invalid spec: :/var/run/docker.sock:ro,z: empty section between colons", которая возникает, когда переменная `DOCKER_SOCKET_LOCATION` не определена.

## Технические детали решения

1. Определение всех сетей в одном файле обеспечивает единую точку контроля
2. Полное удаление определений сетей из всех остальных файлов (а не просто комментирование) гарантирует отсутствие конфликтов
3. Использование абсолютного пути для Docker сокета устраняет зависимость от переменной окружения
4. Различные имена для похожих сервисов (zep-db, supabase-db) предотвращают конфликты имен

Этот подход более надежен, чем использование атрибута `external: true`, так как даже с этим атрибутом могут возникать конфликты при параллельном запуске множества контейнеров.

## Дополнительные советы

1. **Предотвращение конфликтов в будущем**: При добавлении новых сервисов или compose-файлов, следуйте правилу: не используйте атрибуты `name` в определениях сетей основного файла, если вы ссылаетесь на эти сети как `external: true` в других файлах.

2. **Диагностика сетевых проблем**: Используйте команду `docker network ls` для просмотра всех сетей и команду `docker network inspect <имя_сети>` для получения подробной информации о конкретной сети.

3. **Специфика Docker Compose v2**: В Docker Compose v2 изменилась обработка сетей при импорте файлов. Эти инструкции оптимизированы для версии 2.x. Если вы используете более старую версию, может потребоваться другой подход.
